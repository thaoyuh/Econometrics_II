---
title: "Assignment 5"
author: "Group name: Foodies with hoodies"
format: pdf
pdf:
  documentclass: article
  cite-method: biblatex
editor: visual
include-in-header:
  text: |
    \addtokomafont{disposition}{\rmfamily}
    \usepackage{amsmath}
    \newcommand{\bm}{\symbf}
    \newcommand{\T}{\text{T}}
    \newcommand{\pl}{\text{plim}}
    \newcommand{\brefsection}[1]{Section \textcolor{blue}{\ref{#1}}}
    \newcommand{\beqref}[1]{Equation \textcolor{blue}{\eqref{#1}}}
    \newcommand{\breftable}[1]{Table \textcolor{blue}{\ref{#1}}}
    \newcommand{\breffig}[1]{Figure \textcolor{blue}{\ref{#1}}}
    \usepackage{fancyvrb}
    \usepackage{dcolumn}
    \usepackage{fvextra}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{
      showspaces = false,
      showtabs = false,
      breaklines,
      commandchars=\\\{\}
    }
pdf-engine: xelatex
cap-location: top
toc: true
toc-title: Contents
number-sections: true
mainfont: Arial
setspace:
  linestretch: 1.25
fig-align: center
table-align: center
fig-pos: H
table-pos: H
execute:
  echo: true
  warning: false
  eval: true
code-line-numbers: false
colorlinks: true
code-block-bg: darkgray
df-print: default
highlight-style: arrow-dark
biblio-title: References
---

\clearpage

```{r setup q1, echo=TRUE, results='hide'}
# load packages
if(!require(pacman)){install.packages("pacman")}

p_load(devtools,tidyverse,dplyr,ggplot2,latex2exp,stargazer, fixest, modelsummary)
```

\section{Question 1:}

\subsection{(i)}
\emph{I'm not 100$\%$ sure about this one, but here is my answer:}

Suppose the differences in outcomes between the treatment and the control group is:
\begin{equation} \label{eq_1}
Y_{g1} - Y_{g0}=(\alpha_1-\alpha_0) + \delta D_g + (U_{g1} - U_{g0}),
\end{equation}
in which: $\delta$ is the treatment effect.

The parallel trends assumption state that without the intervention of the treatment $(\delta =0)$, the difference of between the control and treatment group ($\alpha_1-\alpha_0$) remain constant over time. Since in this example, they only look at the pre-treatment period, the parallel trends assumption could be violated due to the fact that after the treatment period, the differences in outcomes of control and treatment groups are not constant over time anymore.

When parallel trend is violated, it means that $\alpha_1-\alpha_0$ changes over time and this means it is no longer to estimate Equation \ref{eq_1} using OLS. If we continue estimating it using OLS, we will have a biased and inconsistent estimator (?). 

One example for violation of this assumption could be that the there exists autocorrelation in the treatment group after getting treated. Specifically, the outcome of the next time lag is influenced by the outcome of the previous lag. Before the treatment previous, both the control and the treatment group have the same time trend because both experience no treatment. However, after receiving the treatment,the treated group has a steeper slope in their outcomes and is no longer parallel to the control group.

\subsection{(ii)}
The difference-in-difference estimator is an OLS estimator Equation \ref{eq_1}, which can be written in the form below:

\begin{equation} \label{eq_2}
Y_{g1} - Y_{g0}=\beta_0 + \delta D_g + U_g.
\end{equation}

The main problem with applying the OLS estimator in this case is that the estimator will be inconsistent. This is because the estimator treats the time trend $\beta_0$ as a constant, however, in this case, the parallel trends assumption is not satisfied and thus $\beta_0$ is not constant. This makes the error term changes over time and is correlated with the treatment variable $D_g$.

MAYBE WE CAN STILL ELABORATE MORE HERE?
\section{Question 2:}
```{r}
dfData = read.csv("assignment5.csv")
attach(dfData)
```

\subsection{(i)}
```{r}
# Get subgroups and mean per year
df_scarlet = dfData[dfData$treated==1,]
mean_scarlet = df_scarlet %>% group_by(year) %>% 
  summarise(mean_rate=mean(lnm_rate),
            .groups = 'drop')
df_tuber = dfData[dfData$treated==0,]
mean_tuber = df_tuber %>% group_by(year) %>% 
  summarise(mean_rate=mean(lnm_rate),
            .groups = 'drop')

# reformat into dataframe
df_grouped = data.frame(mean_tuber$year,mean_scarlet$mean_rate,mean_tuber$mean_rate)
names(df_grouped) = c("year","mean_scarlet","mean_tuber")

# Plot
ggplot() +                    
  geom_line(data=df_grouped,aes(y=mean_scarlet,x= year,colour="Scarlet"),size=1 )+
  geom_line(data=df_grouped,aes(y=mean_tuber,x= year,colour="Tuber"),size=1) +
  scale_color_manual(name = "Disease", values = c("Tuber" = "darkblue", "Scarlet" = "red")) + 
  geom_vline(xintercept = 1937) #add a vertical line indicating treatment year
```

\subsection{(ii)}
```{r}
# get mean effects
mean_treated_1936 = df_scarlet[df_scarlet$year==1936,] %>% 
  summarise(mean_rate=mean(lnm_rate),
            .groups = 'drop')
mean_treated_1937 = df_scarlet[df_scarlet$year==1937,] %>% 
  summarise(mean_rate=mean(lnm_rate),
            .groups = 'drop')

mean_control_1936 = df_tuber[df_tuber$year==1936,] %>% 
  summarise(mean_rate=mean(lnm_rate),
            .groups = 'drop')
mean_control_1937 = df_tuber[df_tuber$year==1937,] %>% 
  summarise(mean_rate=mean(lnm_rate),
            .groups = 'drop')
```
\begin{table}[]
\centering
\begin{tabular}{|l|l|l|l|}
\hline
           & Before treatment (1936) & After treatment (1937) & Difference \\ \hline
Treatment  & -10.96                  & -11.43                 & 0.47       \\ \hline
Control    & -7.61                   & -7.63                  & 0.02       \\ \hline
Difference & -3.35                   & -3.8                   & 0.45       \\ \hline
\end{tabular}
\end{table}

The difference-in-differences estimator is 0.45

HERE MAYBE I ROUNDED IT TOO MUCH, you should recalculate before rounding to the 3rd or 4th decimal probably. Because I hear others got 0.439, which is 0.44.

\subsection{(iii)}
```{r}
# Create indicator variable
dfData$indicator <- ifelse(dfData$year >=1937, 1, 0)

# Get subdata for the year 1936 and 1937
dfSub = dfData[dfData$year==1936 | dfData$year==1937,]

# DiD model
DiD1 = feols(lnm_rate ~ indicator*treated|year + treated, data = dfSub, se="standard")
```

\subsection{(iv)}
```{r}

DiD2= feols(lnm_rate ~ indicator*treated| year + treated, data = dfData, se="standard")
msummary(list(DiD1,DiD2), stars = c('*' = .1, '**' = .05, '***' = .01))
```

\subsection{(v)}
For this question, we can take out the two-way fixed effect of group and year and create an interaction variable of year and treated group, making the year 1936 the reference year and thus normalize its correficients to 0.
```{r}
es <- feols(lnm_rate ~ i(year, treated, ref = 1936)|year+treated, data = dfData)
summary(es)
coefplot(es)
```

\subsection{(vi)}
We need to cluster standard errors at he fixed effect levels: namely year and treated

\subsection{(vii)}
For this, we can use the Wald test to check to check on the pretrends from the event study model.
```{r}
# https://lrberge.github.io/fixest/reference/wald.html
wald(es, keep="year::[19251926192719281929193019311932193319341935]$")
```

we can use the placebo test, in which we pick fake treatment periods before the actual treatment period and see if there is a significant effect.
```{r}
# Create fake indicator variables
dfData$D_fake1 <- ifelse(dfData$year >=1928, 1, 0)
dfData$D_fake2 <- ifelse(dfData$year >=1930, 1, 0)
dfData$D_fake3 <- ifelse(dfData$year >=1932, 1, 0)
dfData$D_fake4 <- ifelse(dfData$year >=1934, 1, 0)

# Test fake models
DiD1_fake = feols(lnm_rate ~ D_fake1*treated|year + treated, data = dfData, cluster = "treated^year")
DiD2_fake = feols(lnm_rate ~ D_fake2*treated|year + treated, data = dfData, cluster = "treated^year")
DiD3_fake = feols(lnm_rate ~ D_fake3*treated|year + treated, data = dfData, cluster = "treated^year")
DiD4_fake = feols(lnm_rate ~ D_fake4*treated|year + treated, data = dfData, cluster = "treated^year")
msummary(list(DiD1_fake,DiD2_fake,DiD3_fake,DiD4_fake), stars = c('*' = .1, '**' = .05, '***' = .01))
```


---
title: "Assignment 2"
author: "David Gyaraki, Thao Le"
format: pdf
pdf:
  documentclass: article
  cite-method: biblatex
editor: visual
include-in-header:
  text: |
    \addtokomafont{disposition}{\rmfamily}
    \usepackage{amsmath}
    \newcommand{\bm}{\symbf}
    \newcommand{\T}{\text{T}}
    \newcommand{\pl}{\text{plim}}
    \usepackage{fancyvrb}
    \usepackage{fvextra}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{
      showspaces = false,
      showtabs = false,
      breaklines,
      commandchars=\\\{\}
    }
pdf-engine: xelatex
cap-location: top
toc: true
toc-title: Contents
number-sections: true
mainfont: Arial
setspace:
  linestretch: 1.25
fig-align: center
table-align: center
fig-pos: H
table-pos: H
execute:
  echo: true
  warning: false
  eval: true
code-line-numbers: false
colorlinks: true
code-block-bg: darkgray
df-print: default
highlight-style: arrow-dark
biblio-title: References
---

\clearpage

```{r setup}
# load packages
if(!require(pacman)){install.packages("pacman")}

p_load(devtools,tidyverse,dplyr,ggplot2,latex2exp,
       sampleSelection, quantreg)

#load data
dfData = read.csv("assignment2a_2023.csv")
attach(dfData)
```

```{=tex}
\section{Question 1}
\subsection{(i)}
```

```{r quantile plot}
# Get the quantile values
quant=quantile(lntotexp, seq(0.1, 0.9, by=.4))
n = length(lntotexp)

# Histogram of log of total medical expenditure
hist(lntotexp)

# Quantile plot of log of total medical expenditure
plot((1:n - 1)/(n - 1), sort(lntotexp), type="l",
main = "Quantiles for log of total medical expenditure",
xlab = "Sample Fraction",
ylab = "Sample Quantile") + abline(h=quant, col = c("dark green","red", "blue"))
```

In the quantile plot, the median is indicated by the red line, the 10$^{th}$ and 90$^{th}$ quantile are indicated by the blue and green lines.

We can see from the distribution of log of total medical expenditure that there are few values from 0 to 4. Thus, the quantile plot increases quickly in this region. From 4 to 6, we see an increase frequencies of observations, thus, the quantile plot increases slower. The most rapid increase in the quantile plot is observed between 6 and 10, which makes sense because that is the region where most observations lie. After 10, there are less observations and the quantile plot increases rapidly again.

Although the quantile plot increases rapidly in both regions from 0 to 4 and 10 to 12, we observed a much steeper increase from 0 to 4, thus, we can say that the distribution of log total medical expenditure is left-skewed. This is confirmed by looking at its histogram.

\subsection{(ii)}

```{r quant_regression}
# Quantile regression
q= c(0.1,0.25,0.5,0.75,0.9)
quant_reg = rq(lntotexp ~ . , tau = q, data = dfData)
summary(quant_reg)
```

Looking at the results, we observe different coefficients across the different quantiles. Quite expectedly, we have increasing intercept coefficients, however the interesting part is the different significance of the coefficients in the different quantile regressions. We observe that for the 0.1 quantile, the female and white dummies are insignificant, for the 0.25 and 0.5 quantiles only the female dummy is insignificant, for the 0.75, interestingly the white dummy is insignificant while the female dummy turns out to be significant, and for the 0.9 quantile, only the chronic illness variable seems to be strongly significant with the female dummy slightly (at 10\% level) significant too. These trends will lead to the conclusion that the different predictors likely have different dynamics across the groups of patients when ordered by medical expenditure. Being white significantly increases medical expenditure in the mid-groups but not in the tails of the expenditure distribution. Age and extra insurance are associated with significant increase in costs for low spending groups but not for the highest spenders, and gender comes into influence for the highest spenders only. Let us then look at the OLS results, coefficients and their significance levels.

```{r OLS_1ii}
# OLS Regression
OLS_reg = lm(lntotexp ~ . , data = dfData)
summary(OLS_reg)
```

When one looks at the OLS regression results, the model shows that most variables are statistically significant for explaining the logarithm of medical expenditure, except for the female dummy variable. The variables \textit{age}, \textit{totchr} and \textit{suppins} all have positive effect on medical expenditure with less than 0.001 significance, and the variable \textit{white} has a positive effect as well on 5\% significance level. The interpretation of the coefficients can also be given as one unit increase in the independent variables (keeping all else equal) increases the medical expenditure by $(exp(\beta_k)-1) * 100)$ percentage. We can see below, that a year of age increase will result in an estimated 1.274\% increase in medical expenses. Similarly, being female reduces the expenses by -7.366\% (although this is only significant at 10\% level in the OLS model), being white is associated with 37.412\% increase in medical expenses, an additional chronic illness will increase expenditure by 56.091\% and having a supplementary private insurance will result in 29.280\% increase in medical expenses. 

```{r OLS_coeff}
(exp(OLS_reg$coefficients)-1)*100
```

\subsection{(iii)}

```{r all quantiles reg}
# Quantile regression in increments of 0.05
q_005 = seq(0.05, 1, length.out=20)
quant_reg_005 = rq(lntotexp ~ . , tau = q_005, data = dfData)
summary(quant_reg_005,se = "iid")
```




